import { Job, FreelancerProfile, JobCategory, JobStatus } from './types';

// ==========================================
// –ù–ê–°–¢–†–û–ô–ö–ò –ê–î–ú–ò–ù–ò–°–¢–†–ê–¢–û–†–ê –ò –û–ü–õ–ê–¢–´
// ==========================================

// 1. ID –ê–î–ú–ò–ù–ò–°–¢–†–ê–¢–û–†–û–í (–ö—Ç–æ –≤–∏–¥–∏—Ç –∫–Ω–æ–ø–∫—É "–ê–¥–º–∏–Ω" –≤ –º–µ–Ω—é)
// –£–∑–Ω–∞—Ç—å —Å–≤–æ–π ID –º–æ–∂–Ω–æ –≤ –±–æ—Ç–µ: @userinfobot
export const ADMIN_IDS = [
    479936811, 
    123456789, 
    378436952
];

// 2. USERNAME –î–õ–Ø –û–¢–ü–†–ê–í–ö–ò –ß–ï–ö–û–í
// –°—é–¥–∞ –ø–µ—Ä–µ–∫–∏–Ω–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –ø–æ—Å–ª–µ –Ω–∞–∂–∞—Ç–∏—è "–Ø –æ–ø–ª–∞—Ç–∏–ª".
// –í–ø–∏—Å—ã–≤–∞–π—Ç–µ –ë–ï–ó —Å–æ–±–∞—á–∫–∏ (@).
export const ADMIN_USERNAME = "yorzhik"; 

// 3. –†–ï–ö–í–ò–ó–ò–¢–´ –ö–ê–†–¢–´ (Fallback ‚Äî –µ—Å–ª–∏ donate.stream –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω)
export const PAYMENT_DETAILS = {
    card: "2204 3107 7135 1460",
    bank: "–Ø-–ü—ç–π (Yandex)",
    recipient: "–ò–≤–∞–Ω –ò.",
    phone: "+7 (999) 000-00-00"
};

// 4. DONATE.STREAM ‚Äî –û–°–ù–û–í–ù–û–ô –°–ü–û–°–û–ë –û–ü–õ–ê–¢–´
export const DONATE_STREAM = {
    enabled: true, // false = –æ—Ç–∫–∞—Ç –Ω–∞ —Å—Ç–∞—Ä—É—é –æ–ø–ª–∞—Ç—É –∫–∞—Ä—Ç–æ–π
    pageSlug: "hey_freelancer", // –≤–∞—à —Å–ª–∞–≥ –Ω–∞ donate.stream
    
    // –ì–µ–Ω–µ—Ä–∞—Ü–∏—è —Å—Å—ã–ª–∫–∏ (donate.stream –ù–ï –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç ?message= –ø–∞—Ä–∞–º–µ—Ç—Ä)
    buildPaymentUrl: (amount: number) => {
        return `https://donate.stream/hey_freelancer?sum=${amount}`;
    },
    
    // –ì–µ–Ω–µ—Ä–∞—Ü–∏—è —Ç–µ–∫—Å—Ç–∞ –¥–ª—è –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è –≤ –ø–æ–ª–µ "–°–æ–æ–±—â–µ–Ω–∏–µ"
    buildMessage: (jobId: string, promoFlags: string) => {
        return `JOB#${jobId}|${promoFlags}`;
    }
};

// ==========================================
// –¶–ï–ù–´ –ò –ö–û–ù–°–¢–ê–ù–¢–´
// ==========================================

export const PROMOTION_PRICES = {
    PIN: 50,        // –¶–µ–Ω–∞ –∑–∞ –∑–∞–∫—Ä–µ–ø (RUB)
    HIGHLIGHT: 50,  // –¶–µ–Ω–∞ –∑–∞ –≤—ã–¥–µ–ª–µ–Ω–∏–µ (RUB)
    URGENT: 50      // –¶–µ–Ω–∞ –∑–∞ "–°—Ä–æ—á–Ω–æ" (RUB)
};

// –í–µ—Ä—Å–∏—è –æ–Ω–±–æ—Ä–¥–∏–Ω–≥–∞ - –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ –ø–æ–∫–∞–∑–∞—Ç—å –æ–Ω–±–æ—Ä–¥–∏–Ω–≥ –≤—Å–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º –∑–∞–Ω–æ–≤–æ
export const ONBOARDING_VERSION = 2;

export const CATEGORY_LABELS: Record<JobCategory, string> = {
  [JobCategory.ALL]: '–í—Å–µ',
  [JobCategory.DEVELOPMENT]: '–†–∞–∑—Ä–∞–±–æ—Ç–∫–∞',
  [JobCategory.DESIGN]: '–î–∏–∑–∞–π–Ω',
  [JobCategory.MARKETING]: '–ú–∞—Ä–∫–µ—Ç–∏–Ω–≥',
  [JobCategory.COPYWRITING]: '–¢–µ–∫—Å—Ç—ã',
  [JobCategory.OTHER]: '–†–∞–∑–Ω–æ–µ'
};

export const MOCK_JOBS: Job[] = [
  {
    id: '1',
    authorId: 999,
    authorName: 'Alice Corp',
    authorUsername: 'alice_pm',
    title: 'Frontend –Ω–∞ React –¥–ª—è –î–∞—à–±–æ—Ä–¥–∞',
    description: '–ù—É–∂–µ–Ω Senior React —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –∞–Ω–∞–ª–∏—Ç–∏—á–µ—Å–∫–æ–≥–æ –¥–∞—à–±–æ—Ä–¥–∞ —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º Recharts. –°—Ä–æ–∫: 2 –Ω–µ–¥–µ–ª–∏.',
    budget: '150 000 ‚ÇΩ',
    category: JobCategory.DEVELOPMENT,
    status: JobStatus.OPEN,
    createdAt: new Date(Date.now() - 86400000).toISOString(),
    isPinned: true,
    isHighlighted: true,
    proposalsCount: 3
  },
  {
    id: '2',
    authorId: 888,
    authorName: 'Bob Studio',
    authorUsername: 'bob_design',
    title: '–õ–æ–≥–æ—Ç–∏–ø –¥–ª—è –ö–æ—Ñ–µ–π–Ω–∏',
    description: '–¢—Ä–µ–±—É–µ—Ç—Å—è –º–∏–Ω–∏–º–∞–ª–∏—Å—Ç–∏—á–Ω—ã–π –ª–æ–≥–æ—Ç–∏–ø –¥–ª—è –Ω–æ–≤–æ–π —Ö–∏–ø—Å—Ç–µ—Ä—Å–∫–æ–π –∫–æ—Ñ–µ–π–Ω–∏ –≤ —Ü–µ–Ω—Ç—Ä–µ.',
    budget: '30 000 ‚ÇΩ',
    category: JobCategory.DESIGN,
    status: JobStatus.OPEN,
    createdAt: new Date(Date.now() - 172800000).toISOString(),
    isUrgent: true,
    proposalsCount: 0
  }
];

export const MOCK_FREELANCERS: FreelancerProfile[] = [
  {
    userId: 777,
    displayName: '–ò–≤–∞–Ω –ü–µ—Ç—Ä–æ–≤',
    username: 'ivan_dev',
    bio: 'Full Stack JS —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫. 5 –ª–µ—Ç –æ–ø—ã—Ç–∞ —Å Node.js –∏ React.',
    skills: ['React', 'Node.js', 'PostgreSQL'],
    portfolioLinks: ['https://github.com/ivan', 'https://ivan.dev']
  },
  {
    userId: 666,
    displayName: '–ú–∞—Ä–∏—è –°–∏–¥–æ—Ä–æ–≤–∞',
    username: 'maria_ui',
    bio: 'UI/UX –î–∏–∑–∞–π–Ω–µ—Ä, —Å–ø–µ—Ü–∏–∞–ª–∏–∑–∏—Ä—É—é—Å—å –Ω–∞ –º–æ–±–∏–ª—å–Ω—ã—Ö –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞—Ö.',
    skills: ['Figma', 'Tailwind', 'UI Design'],
    portfolioLinks: ['https://behance.net/maria']
  }
];

// Content for the Architecture/Backend Deliverables
export const BACKEND_DOCS = {
  dbSchema: `
-- 1. –°–•–ï–ú–ê –¢–ê–ë–õ–ò–¶ (TABLES)

CREATE TABLE IF NOT EXISTS public.users (
    tg_id BIGINT PRIMARY KEY,
    first_name TEXT NOT NULL,
    last_name TEXT,
    username TEXT,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

CREATE TABLE IF NOT EXISTS public.jobs (
    id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    author_id BIGINT REFERENCES public.users(tg_id),
    title TEXT NOT NULL,
    description TEXT NOT NULL,
    budget TEXT,
    category TEXT DEFAULT 'OTHER', 
    status TEXT DEFAULT 'PENDING',
    is_active BOOLEAN DEFAULT TRUE,
    is_pinned BOOLEAN DEFAULT FALSE,
    is_highlighted BOOLEAN DEFAULT FALSE,
    is_urgent BOOLEAN DEFAULT FALSE,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

CREATE TABLE IF NOT EXISTS public.profiles (
    user_id BIGINT PRIMARY KEY REFERENCES public.users(tg_id),
    bio TEXT,
    skills TEXT[],
    portfolio_links TEXT[],
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

CREATE TABLE IF NOT EXISTS public.proposals (
    id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
    job_id BIGINT REFERENCES public.jobs(id) ON DELETE CASCADE,
    freelancer_id BIGINT REFERENCES public.profiles(user_id),
    cover_letter TEXT,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    UNIQUE(job_id, freelancer_id)
);

-- –ü–ê–†–¢–ù–Å–†–°–ö–ò–ï –ö–ê–ù–ê–õ–´ (White-label)
CREATE TABLE IF NOT EXISTS public.channels (
    id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    channel_id BIGINT NOT NULL UNIQUE,           -- Telegram channel ID
    channel_username TEXT,                        -- @username –∫–∞–Ω–∞–ª–∞
    channel_title TEXT,                           -- –ù–∞–∑–≤–∞–Ω–∏–µ –∫–∞–Ω–∞–ª–∞ –∏–∑ Telegram
    owner_id BIGINT REFERENCES public.users(tg_id),
    categories TEXT[] DEFAULT '{}',               -- –§–∏–ª—å—Ç—Ä –∫–∞—Ç–µ–≥–æ—Ä–∏–π
    min_budget INT DEFAULT 0,                     -- –ú–∏–Ω. –±—é–¥–∂–µ—Ç (0 = –≤—Å–µ)
    is_active BOOLEAN DEFAULT TRUE,
    subscribers_count INT DEFAULT 0,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- –°–≤—è–∑—å –∑–∞–∫–∞–∑–æ–≤ —Å –∫–∞–Ω–∞–ª–∞–º–∏
CREATE TABLE IF NOT EXISTS public.channel_jobs (
    id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    job_id BIGINT REFERENCES public.jobs(id) ON DELETE CASCADE,
    channel_id BIGINT REFERENCES public.channels(id) ON DELETE CASCADE,
    telegram_message_id BIGINT,                   -- ID –ø–æ—Å—Ç–∞ –≤ –∫–∞–Ω–∞–ª–µ
    status TEXT DEFAULT 'pending',                -- pending/published/deleted
    published_at TIMESTAMP WITH TIME ZONE,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    UNIQUE(job_id, channel_id)
);

-- –ò–Ω–¥–µ–∫—Å—ã –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ –ø–æ–∏—Å–∫–∞
CREATE INDEX IF NOT EXISTS idx_channels_owner ON public.channels(owner_id);
CREATE INDEX IF NOT EXISTS idx_channels_active ON public.channels(is_active);
CREATE INDEX IF NOT EXISTS idx_channel_jobs_job ON public.channel_jobs(job_id);
CREATE INDEX IF NOT EXISTS idx_channel_jobs_channel ON public.channel_jobs(channel_id);

-- 2. –ü–†–ê–í–ê –î–û–°–¢–£–ü–ê (RLS POLICIES)
-- –≠—Ç–æ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏ –≤–∞–∂–Ω–æ! –ë–µ–∑ —ç—Ç–æ–≥–æ –±–∞–∑–∞ –Ω–µ –¥–∞—Å—Ç —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –¥–∞–Ω–Ω—ã–µ.

ALTER TABLE public.users ENABLE ROW LEVEL SECURITY;
CREATE POLICY "Allow public access" ON public.users FOR ALL USING (true);

ALTER TABLE public.jobs ENABLE ROW LEVEL SECURITY;
CREATE POLICY "Allow public access" ON public.jobs FOR ALL USING (true);

ALTER TABLE public.profiles ENABLE ROW LEVEL SECURITY;
CREATE POLICY "Allow public access" ON public.profiles FOR ALL USING (true);

ALTER TABLE public.proposals ENABLE ROW LEVEL SECURITY;
CREATE POLICY "Allow public access" ON public.proposals FOR ALL USING (true);

ALTER TABLE public.channels ENABLE ROW LEVEL SECURITY;
CREATE POLICY "Allow public access" ON public.channels FOR ALL USING (true);

ALTER TABLE public.channel_jobs ENABLE ROW LEVEL SECURITY;
CREATE POLICY "Allow public access" ON public.channel_jobs FOR ALL USING (true);
`,
  edgeFunction: `
// supabase/functions/telegram-bot/index.ts
import { serve } from "https://deno.land/std@0.168.0/http/server.ts"
import { createClient } from "https://esm.sh/@supabase/supabase-js@2"

const BOT_TOKEN = Deno.env.get('BOT_TOKEN')!
const SUPABASE_URL = Deno.env.get('SUPABASE_URL')!
const SUPABASE_SERVICE_ROLE_KEY = Deno.env.get('SUPABASE_SERVICE_ROLE_KEY')!
const BOT_USERNAME = 'hey_birazhabot' // –í–∞—à –±–æ—Ç

const supabase = createClient(SUPABASE_URL, SUPABASE_SERVICE_ROLE_KEY)

// Helper to send message
const sendMessage = async (chat_id: number | string, text: string, reply_markup?: any) => {
  if (!chat_id) return null
  const res = await fetch(\`https://api.telegram.org/bot\${BOT_TOKEN}/sendMessage\`, {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ 
      chat_id, 
      text, 
      parse_mode: 'HTML',
      reply_markup 
    })
  })
  return res.json()
}

// –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∑–∞–∫–∞–∑–∞ –¥–ª—è –ø—É–±–ª–∏–∫–∞—Ü–∏–∏ –≤ –∫–∞–Ω–∞–ª
const formatJobPost = (job: any) => {
  const categoryEmoji: Record<string, string> = {
    'DEVELOPMENT': 'üíª',
    'DESIGN': 'üé®',
    'MARKETING': 'üìà',
    'COPYWRITING': '‚úçÔ∏è',
    'OTHER': 'üì¶'
  }
  
  const emoji = categoryEmoji[job.category] || 'üì¶'
  const urgentBadge = job.is_urgent ? 'üî• –°–†–û–ß–ù–û\\n\\n' : ''
  
  return \`\${urgentBadge}\${emoji} <b>\${job.title}</b>

\${job.description.slice(0, 500)}\${job.description.length > 500 ? '...' : ''}

üí∞ <b>–ë—é–¥–∂–µ—Ç:</b> \${job.budget || '–î–æ–≥–æ–≤–æ—Ä–Ω–∞—è'}

<a href="https://t.me/\${BOT_USERNAME}/app?startapp=job_\${job.id}">üëâ –û—Ç–∫–ª–∏–∫–Ω—É—Ç—å—Å—è</a>\`
}

serve(async (req) => {
  try {
    const payload = await req.json()
    const { type, table, record, old_record } = payload

    // 1. NEW JOB -> NOTIFY ADMINS
    if (table === 'jobs' && type === 'INSERT') {
       const ADMIN_IDS = [${ADMIN_IDS.join(', ')}] 
       const text = \`‚ö°Ô∏è <b>–ù–æ–≤—ã–π –∑–∞–∫–∞–∑ –Ω–∞ –º–æ–¥–µ—Ä–∞—Ü–∏—é!</b>\\n\\nTitle: \${record.title}\\nBudget: \${record.budget}\\n\\n<a href="https://t.me/\${BOT_USERNAME}">–û—Ç–∫—Ä—ã—Ç—å –ê–¥–º–∏–Ω–∫—É</a>\`
       await Promise.all(ADMIN_IDS.map(id => sendMessage(id, text)))
    }

    // 2. JOB STATUS CHANGE -> NOTIFY AUTHOR + PUBLISH TO CHANNELS
    if (table === 'jobs' && type === 'UPDATE' && record.status !== old_record.status) {
       const statusText = record.status === 'OPEN' ? '‚úÖ –û–ø—É–±–ª–∏–∫–æ–≤–∞–Ω' : '‚ùå –ó–∞–∫—Ä—ã—Ç/–û—Ç–∫–ª–æ–Ω–µ–Ω'
       const text = \`üîî –°—Ç–∞—Ç—É—Å –∑–∞–∫–∞–∑–∞ <b>"\${record.title}"</b> –∏–∑–º–µ–Ω–µ–Ω:\\n\${statusText}\`
       await sendMessage(record.author_id, text)
       
       // –ï—Å–ª–∏ –∑–∞–∫–∞–∑ –æ–¥–æ–±—Ä–µ–Ω ‚Äî –ø—É–±–ª–∏–∫—É–µ–º –≤ –∫–∞–Ω–∞–ª—ã
       if (record.status === 'OPEN') {
         const { data: channelJobs } = await supabase
           .from('channel_jobs')
           .select('*, channels(*)')
           .eq('job_id', record.id)
           .eq('status', 'pending')
         
         if (channelJobs && channelJobs.length > 0) {
           const jobPost = formatJobPost(record)
           
           for (const cj of channelJobs) {
             try {
               const result = await sendMessage(cj.channels.channel_id, jobPost)
               if (result?.ok && result?.result?.message_id) {
                 await supabase
                   .from('channel_jobs')
                   .update({ 
                     status: 'published', 
                     telegram_message_id: result.result.message_id,
                     published_at: new Date().toISOString()
                   })
                   .eq('id', cj.id)
               }
             } catch (e) {
               console.error('Failed to publish to channel:', cj.channels.channel_id, e)
             }
           }
         }
       }
    }

    // 3. NEW PROPOSAL -> NOTIFY JOB AUTHOR
    if (table === 'proposals' && type === 'INSERT') {
       const { data: job } = await supabase.from('jobs').select('title, author_id').eq('id', record.job_id).single()
       if (job) {
         const text = \`üëã <b>–ù–æ–≤—ã–π –æ—Ç–∫–ª–∏–∫ –Ω–∞ –∑–∞–∫–∞–∑!</b>\\n\\n–ó–∞–∫–∞–∑: \${job.title}\\n–¢–µ–∫—Å—Ç: "<i>\${record.cover_letter.slice(0, 50)}...</i>"\`
         await sendMessage(job.author_id, text)
       }
    }
    
    // 4. NEW CHANNEL_JOB -> PUBLISH IF JOB IS ALREADY OPEN
    if (table === 'channel_jobs' && type === 'INSERT') {
       const { data: job } = await supabase.from('jobs').select('*').eq('id', record.job_id).single()
       const { data: channel } = await supabase.from('channels').select('*').eq('id', record.channel_id).single()
       
       if (job && channel && job.status === 'OPEN') {
         const jobPost = formatJobPost(job)
         const result = await sendMessage(channel.channel_id, jobPost)
         
         if (result?.ok && result?.result?.message_id) {
           await supabase
             .from('channel_jobs')
             .update({ 
               status: 'published', 
               telegram_message_id: result.result.message_id,
               published_at: new Date().toISOString()
             })
             .eq('id', record.id)
         }
       }
    }

    return new Response("OK", { status: 200 })
  } catch (error) {
    return new Response(JSON.stringify({ error: error.message }), { status: 500 })
  }
})
`,
  webhookSql: `
-- 3. –ù–ê–°–¢–†–û–ô–ö–ê –£–í–ï–î–û–ú–õ–ï–ù–ò–ô (WEBHOOKS)

-- A. –í–∫–ª—é—á–∞–µ–º —Ä–∞—Å—à–∏—Ä–µ–Ω–∏–µ –¥–ª—è HTTP –∑–∞–ø—Ä–æ—Å–æ–≤
create extension if not exists pg_net;

-- B. –§—É–Ω–∫—Ü–∏—è –æ—Ç–ø—Ä–∞–≤–∫–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
create or replace function public.handle_telegram_notification()
returns trigger as $$
declare
  -- ‚ö†Ô∏è –ó–ê–ú–ï–ù–ò–¢–ï –≠–¢–ò –ó–ù–ê–ß–ï–ù–ò–Ø –ù–ê –í–ê–®–ò –ò–ó SUPABASE SETTINGS ‚ö†Ô∏è
  project_ref text := '[YOUR_PROJECT_REF]'; 
  service_role_key text := '[YOUR_SERVICE_ROLE_KEY]';
  
  -- –°—Å—ã–ª–∫–∞ –Ω–∞ Edge Function
  url text := 'https://' || project_ref || '.supabase.co/functions/v1/telegram-bot';
begin
  perform net.http_post(
    url := url,
    headers := jsonb_build_object(
      'Content-Type', 'application/json',
      'Authorization', 'Bearer ' || service_role_key
    ),
    body := jsonb_build_object(
      'type', TG_OP,
      'table', TG_TABLE_NAME,
      'schema', TG_TABLE_SCHEMA,
      'record', row_to_json(NEW),
      'old_record', CASE WHEN TG_OP = 'INSERT' THEN null ELSE row_to_json(OLD) END
    )
  );
  return NEW;
end;
$$ language plpgsql;

-- C. –°–æ–∑–¥–∞–µ–º —Ç—Ä–∏–≥–≥–µ—Ä—ã
drop trigger if exists on_job_change on public.jobs;
create trigger on_job_change
after insert or update on public.jobs
for each row execute function public.handle_telegram_notification();

drop trigger if exists on_proposal_new on public.proposals;
create trigger on_proposal_new
after insert on public.proposals
for each row execute function public.handle_telegram_notification();

-- D. –¢—Ä–∏–≥–≥–µ—Ä –¥–ª—è –ø—É–±–ª–∏–∫–∞—Ü–∏–∏ –≤ –∫–∞–Ω–∞–ª—ã
drop trigger if exists on_channel_job_new on public.channel_jobs;
create trigger on_channel_job_new
after insert on public.channel_jobs
for each row execute function public.handle_telegram_notification();
`
};
